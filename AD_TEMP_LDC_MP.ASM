;===============================================================================
;====== PROGRAMA PARA INDICAR A TEMPERATURA EM UM LCD E ENVIAR PARA     ========
;====== O COMPUTADOR VIA SERIAL.					========
;====== TODO O HARDWARE ESTARÁ CODIFICADO COM SENHAS.			========
;===============================================================================
;---------------------------------- PINAGEM ---------------------------------------
; CONTROLE DO TECLADO -> P0
; INTERRUPÇÃO EXT -> P3.1
; CONVERSOR AD -> P1
; ENABLE DO LCD -> P2.0
; RS DO LCD -> P2.1
; LCD DE 4 VIAS -> DE 2.4 ATÉ 2.7 
;////////////////////////////REGISTROS UTILIZADOS//////////////////////////////
; R0 R4 R5 08H 09H R2 R6 R7 R1 10H 0AH 0BH
;-----------------------------------------------------------------------------------
; DESENVOLVIDO POR: JOHN DAYTON CHAVES CUTÓDIO
; DATA DE DESENVOLVIMENTO: 03/09/2013
; ULTIMA ATUALIZAÇÃO: 03/09/2013
;======================================================================================
;------------------------------- DEFINIÇÕES DAS FLAGS --------------------------------------

FLAG		EQU	00H		;FLAG DE AUXILIO PARA CONTROLE DE TEMPO DE HABILITAÇÃO DO TIMER0
FLAG1		EQU	01H		;
FLAG_SENHA	EQU	02H		;FLAG QUE INDICA QUE A SENHA ESTÁ CORRETA
FLAG_MOTOR	EQU	03H
FLAG_TEMP	EQU	04H
FLAG_SERIAL	EQU	05H

AD		EQU	P0		;PORTA DE ENTRADA DO AD
DISPLAY		EQU	P2		;BARRAMENTO DE DADOS PARA O LCD
RS		EQU	P2.1		;PINO REFERENTE AO RS DO LCD
ENABLE		EQU	P2.0		;PINO REFERENTE AO ENABLE DO LCD
TECLA		EQU	P1		;PORTA ATRIBUIDA AO TECLADO
M1		EQU	P3.4		;PINO REFERENTE AO MOTOR
M2		EQU	P3.5		;PINO REFERENTE AO MOTOR
M3		EQU	P3.6		;PINO REFERENTE AO MOTOR
M4		EQU	P3.7		;PINO REFERENTE AO MOTOR

;------------------------------- DESVIOS DE IMTERRUPÇÕES -------------------------------------
	ORG	00H
	AJMP	CONFIG
	ORG	03H
	AJMP	EXT_0
	ORG	0BH
	AJMP	TIMR_0
	ORG	1BH
	AJMP	TIMR_1
;============================================ INTERRUPÇÕES ===========================================

;------------------------------------------- EXTERNA 0 -------------------------------------------------
EXT_0:	CLR	TR0		;DESLIGA O TIMER0
	PUSH	ACC		;SALVA NA PILHA O VALOR DO ACUMULADOR PARA CONSERVAR
	MOV	A,P1		;LÊ A PORTA 1
	SETB	FLAG_MOTOR	;SETA A FLAG QUE INFORMA A ENTRADA NO TIMER 0, PARA A ESCRETA DA TECLA PRESSIONADA
	SETB	FLAG		;SETA A FLAG PARA PODER HABILITAR O TIMER 0 APOS UM DETERMINADO TEMPO
				;PARA NÃO ENTRAR NA INTERRUPÇÃO NOVAMENTE

	CJNE	A,#0D7H,EX_1	;VERIFICA SE A TECLA PRESSIONADA FOI '0'
	MOV	@R0,#'0'	;SALVA NA MEMÓRIA O CÓDIGO ASCII DO 0
	AJMP	F_EXT0		;VAI PARA A SAÍDA DA INTERRUPÇÃO

EX_1:	CJNE	A,#0EEH,EX_2	;VERIFICA SE A TECLA PRESSIONADA FOI '1'
	MOV	@R0,#'1'
	AJMP	F_EXT0

EX_2:	CJNE	A,#0DEH,EX_3	;VERIFICA SE A TECLA PRESSIONADA FOI '2'
	MOV	@R0,#'2'
	AJMP	F_EXT0

EX_3:	CJNE	A,#0BEH,EX_4	;VERIFICA SE A TECLA PRESSIONADA FOI '3'
	MOV	@R0,#'3'
	AJMP	F_EXT0

EX_4:	CJNE	A,#0EDH,EX_5	;VERIFICA SE A TECLA PRESSIONADA FOI '4'
	MOV	@R0,#'4'
	AJMP	F_EXT0

EX_5:	CJNE	A,#0DDH,EX_6	;VERIFICA SE A TECLA PRESSIONADA FOI '5'
	MOV	@R0,#'5'
	AJMP	F_EXT0

EX_6:	CJNE	A,#0BDH,EX_7	;VERIFICA SE A TECLA PRESSIONADA FOI '6'
	MOV	@R0,#'6'
	AJMP	F_EXT0

EX_7:	CJNE	A,#0EBH,EX_8	;VERIFICA SE A TECLA PRESSIONADA FOI '7'
	MOV	@R0,#'7'
	AJMP	F_EXT0

EX_8:	CJNE	A,#0DBH,EX_9	;VERIFICA SE A TECLA PRESSIONADA FOI '8'
	MOV	@R0,#'8'
	AJMP	F_EXT0

EX_9:	CJNE	A,#0BBH,EX_10	;VERIFICA SE A TECLA PRESSIONADA FOI '9'
	MOV	@R0,#'9'
	AJMP	F_EXT0

EX_10:	CJNE	A,#07EH,EX_11	;VERIFICA SE A TECLA PRESSIONADA FOI 'A'
	MOV	@R0,#'A'
	AJMP	F_EXT0

EX_11:	CJNE	A,#07DH,EX_12	;VERIFICA SE A TECLA PRESSIONADA FOI 'B'
	MOV	@R0,#'B'
	AJMP	F_EXT0

EX_12:	CJNE	A,#07BH,EX_13	;VERIFICA SE A TECLA PRESSIONADA FOI 'C'
	MOV	@R0,#'C'
	AJMP	F_EXT0

EX_13:	CJNE	A,#77H,EX_14	;VERIFICA SE A TECLA PRESSIONADA FOI 'D'
	MOV	@R0,#'D'
	AJMP	F_EXT0

EX_14:	CJNE	A,#0E7H,EX_15	;VERIFICA SE A TECLA PRESSIONADA FOI '*'
	MOV	@R0,#'*'
	AJMP	F_EXT0

EX_15:	CJNE	A,#0B7H,F_EXT0	;VERIFICA SE A TECLA PRESSIONADA FOI '*'
	MOV	@R0,#23H

F_EXT0:	POP	ACC
	RETI			;SAI DA INTERRUPÇÃO

;---------------------------------------------- TIMER 0 -------------------------------------------------
;

TIMR_0:	PUSH	ACC
	CJNE	R6,#0FEH,T0_1
	MOV	R6,#0EFH
T0_1:	MOV	A,R6
	ANL	A,#0F0H
	MOV	R7,A
	MOV	A,#0FH		;CARREGA O ACUMULADOR COM O VALOR DO TECLADO
;	ANL	A,#0FH		;LIMPA A PARTE MAIS ALTA DO BYTE
	ORL	A,R7		;SOMA AS DUAS PARTES ALTO E BAIXO
	MOV	TECLA,A
	MOV	A,R6
	RL	A
	MOV	R6,A
	POP	ACC
	RETI			;SAI DA INTERRUPÇÃO

;------------------------------------------- TIMER 1 --------------------------------------------------

TIMR_1:	PUSH	ACC		;SALVA O VALOR DO ACUMULADOR
	DJNZ	R3,ESP
	MOV	A,0AH		;MOVE PARA O ACUMULADOR O VALOR DO REGISTRO R2 DO BANCO 1

T1_1:	CJNE	A,#1,T1_2	;VERIFICA QUAL O VALOR DE 0AH PARA SETAR OU LIMPAR OS PINOS REFERENTE A SEQUENCIA
	SETB	M1
	CLR	M2
	CLR	M3
	CLR 	M4
	AJMP	T_1
T1_2:	CJNE	A,#2,T1_3
	CLR	M1
	SETB	M2
	CLR	M3
	CLR 	M4
	AJMP	T_1
T1_3:	CJNE	A,#3,T1_4
	CLR	M1
	CLR	M2
	SETB	M3
	CLR 	M4
	AJMP	T_1
T1_4:	CLR	M1
	CLR	M2
	CLR	M3
	SETB 	M4
	MOV	0AH,#0

T_1:	CJNE	@R0,#'1',T_2	
	MOV	R3,#17		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 1
T_2:	CJNE	@R0,#'2',T_3
	MOV	R3,#15		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 2
T_3:	CJNE	@R0,#'3',T_4
	MOV	R3,#13		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 3
T_4:	CJNE	@R0,#'4',T_5
	MOV	R3,#11		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 4
T_5:	CJNE	@R0,#'5',T_6
	MOV	R3,#10		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 5
T_6:	CJNE	@R0,#'6',T_7
	MOV	R3,#9		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 6
T_7:	CJNE	@R0,#'7',T_8
	MOV	R3,#8		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 7
T_8:	CJNE	@R0,#'8',T_9
	MOV	R3,#7		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 8
T_9:	CJNE	@R0,#'9',T_10
	MOV	R3,#6		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO 9
T_10:	CJNE	@R0,#'A',T_11
	MOV	R3,#5		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO A
T_11:	CJNE	@R0,#'B',T_12
	MOV	R3,#4		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO B
T_12:	CJNE	@R0,#'C',T_13
	MOV	R3,#3		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO C
T_13:	CJNE	@R0,#'D',T_14
	MOV	R3,#2		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO D
T_14:	CJNE	@R0,#'*',SAI_T1
	MOV	R3,#1		;COMANDO DA VELOCIDADE DO MOTOR DE PASSO PARA BOTÃO *

SAI_T1:	INC	0AH
ESP:	POP	ACC		;RECUPERA O VALOR INICIAL DO ACUMULADOR
	RETI			;SAI DA INTERRUPÇÃO

;======================================= ROTINAS DO PROGRAMA ===========================================

;-------------------------------------------- DELAY_MS -------------------------------------------------
; ROTINA VARIÁVEL, COM DURAÇÃO DE 0,5ms x (O VALOR PASADO EM ACUMULADOR(A))
DELAY:	MOV	R4,A		;CARREGA O R4 (UNIDADE DE ms)
	MOV	R5,#255		;CARREGA O R5 (P/ CONTAR 0.5ms)
	DJNZ	R5,$		;DECREMENTA R5 E AGUARDA CHEGAR A 0
	DJNZ	R4,$-3		;DECREMENTA R4 (SE 0 -> SEGUE, SE NÃO -> VOLTA TRÊS OPERAÇÕES)
	RET			;RETORNA DA ROTINA

;-------------------------------------------- ESCREVE --------------------------------------------------
; ESTA ROTINA ENVIA UM CARACTERE PARA O MÓDULO DE LCD.
; O CARACTERE A SER COLOCADO EM ACUMULADOR(A) ANTES DE CHAMAR A ROTINA.
ESCREVE:	MOV	08H,A		;REPASSA O VALOR DE A AO R0 DO BANCO 2	       \	
		ANL	A,#0F0H		;MASCARA OS BYTES MENOS SIGNIFICATIVOS		\
		MOV	09H,A		;SALVA EM R1 DO BANCO 2				 \ROTINA PARA CONSERVAR OS BITS
		MOV	A,DISPLAY	;CARREGA O ACUMULADOR COM O VALOR DO DISPLAY	 /MENOS SIGNIFICATIVOS
		ANL	A,#0FH		;LIMPA A PARTE MAIS ALTA DO BYTE		/
		ORL	A,09H		;SOMA AS DUAS PARTES ALTO E BAIXO	       /

		MOV	DISPLAY,A
		NOP			;PERDE 1us PARA ESTABILIZAÇÃO DO LCD
		SETB	ENABLE		;ENVIA UM PULSO DE ENABLE AO DISPLAY
		NOP
		NOP			;PERDE 2us PARA ESTABILIZAÇÃO DO SINAL ENVIADO
		CLR	ENABLE		;DESLIGA O PULSO

		MOV	A,08H		;RECARREGA O VALOR ORIGINAL DO ACUMULADOR
		SWAP	A		;ALTERA PARTE ALTA COM PARTE BAIXA O BYTE
	
		ANL	A,#0F0H		;MASCARA OS BYTES MENOS SIGNIFICATIVOS		\
		MOV	09H,A		;SALVA EM R1 DO BANCO 2				 \ROTINA PARA CONSERVAR OS BITS
		MOV	A,DISPLAY	;CARREGA O ACUMULADOR COM O VALOR DO DISPLAY	 /MENOS SIGNIFICATIVOS
		ANL	A,#0FH		;LIMPA A PARTE MAIS ALTA DO BYTE		/
		ORL	A,09H		;SOMA AS DUAS PARTES ALTO E BAIXO	       /

		MOV	DISPLAY,A	;RECARREGA A PORTA P2 COM OS VALORES TROCADOS
		NOP			;PERDE 1us PARA ESTABILIZAÇÃO DO LCD
		SETB	ENABLE		;ENVIA UM PULSO DE ENABLE AO DISPLAY
		NOP
		NOP			;PERDE 2us PARA ESTABILIZAÇÃO DO SINAL ENVIADO
		CLR	ENABLE		;DESLIGA O PULSO
		MOV	A,#1
		ACALL	DELAY		;DELAY DE 1ms
		RET			;ROTORNA DA ROTINA

;------------------------- ROTINA DE ESCRITA DA TELA DE PEDIDO DE SENHA --------------------------------
;ESTA ROTINA ESCREVE NA TELA PRINCIPAL DO PROGRAMA, COM AS FRASES
; LINHA 1: SENHA:
; LINHA 2: 
TELA_S:	CLR	RS		;SELECIONA DISPLAY P/ COMANDOS
	MOV	A,#1
	ACALL	ESCREVE		;ESCREVE COMANDO PARA LIMPAR A TELA
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#0EH
	ACALL	ESCREVE		;ESCREVE COMANDO PARA LIGAR CURSOR
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#0DH
	ACALL	ESCREVE		;ESCREVE COMANDO PARA CURSOR PISCANDO
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#82H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 0 / COLUNA 2)
	SETB	RS		;SELECIONA O DISPLAY P/ DADO
; COMANDOS PARA ESCREVER AS LETRAS DE "SENHA:"
	MOV	A,#'S'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'H'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#':'
	ACALL	ESCREVE
	RET
;-------------------------- ROTINA PARA ANALISE DE SENHA ------------------------------
;ROTINA PARA VERIFICAR A SENHA CORRETA

COMPARA:	MOV	R1,#22H
		CJNE	@R1,#'5',F_COMP
		MOV	R1,#23H
		CJNE	@R1,#'C',F_COMP
		MOV	R1,#24H
		CJNE	@R1,#'3',F_COMP
		MOV	R1,#25H
		CJNE	@R1,#'0',F_COMP
		MOV	R1,#26H
		CJNE	@R1,#'A',F_COMP
		SETB	FLAG_SENHA
F_COMP:		MOV	R0,#22H
		RET

;-------------------------- ROTINA PARA MENSAGEM DE ERRO NA SENHA ---------------------
;ESTA ROTINA ESCREVE NA TELA PRINCIPAL DO PROGRAMA, COM AS FRASES
; LINHA 1: Senha INCORRETA
; LINHA 2: Tente novamente
M_ERRO:	CLR	RS		;SELECIONA DISPLAY P/ COMANDOS
	MOV	A,#1
	ACALL	ESCREVE		;ESCREVE COMANDO PARA LIMPAR A TELA
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#0AH
	ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#0CH
	ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#80H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 0 / COLUNA 0)
	SETB	RS		;SELECIONA O DISPLAY P/ DADO
; COMANDOS PARA ESCREVER AS LETRAS DE "Senha INCORRETA"
	MOV	A,#'S'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'H'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#' '
	ACALL	ESCREVE
	MOV	A,#'I'
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'C'
	ACALL	ESCREVE
	MOV	A,#'O'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
; COMANDOS PARA ESCREVER AS LETRAS DE "Tente novamente"
	CLR	RS		;SELECIONA DISPLAY PARA COMANDOS
	MOV	A,#0C0H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 1 / COLUNA 0)
	SETB	RS		;SELECIONA DISPLAY PARA DADOS
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#' '
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'O'
	ACALL	ESCREVE
	MOV	A,#'V'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#'M'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	
	RET


;-------------------------- MENSAGEM MENU -----------------------------
;ESTA ROTINA ESCREVE NA TELA PRINCIPAL DO PROGRAMA, COM AS FRASES
; LINHA 1: 1-MOTOR_P 2-TEMP
; LINHA 2: 3-SERIAL A-SENHA
M_MENU:	CLR	RS		;SELECIONA DISPLAY P/ COMANDOS
	MOV	A,#1
	ACALL	ESCREVE		;ESCREVE COMANDO PARA LIMPAR A TELA
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#0AH
	ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#0CH
	ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
	MOV	A,#2
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#80H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 0 / COLUNA 0)
	SETB	RS		;SELECIONA O DISPLAY P/ DADO
; COMANDOS PARA ESCREVER AS LETRAS DE "1-MOTOR_P 2-TEMP"
	MOV	A,#'1'
	ACALL	ESCREVE
	MOV	A,#'-'
	ACALL	ESCREVE
	MOV	A,#'M'
	ACALL	ESCREVE
	MOV	A,#'O'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'O'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	MOV	A,#'_'
	ACALL	ESCREVE
	MOV	A,#'P'
	ACALL	ESCREVE
	MOV	A,#' '
	ACALL	ESCREVE
	MOV	A,#'2'
	ACALL	ESCREVE
	MOV	A,#'-'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'M'
	ACALL	ESCREVE
	MOV	A,#'P'
	ACALL	ESCREVE
; COMANDOS PARA ESCREVER AS LETRAS DE "3-SERIAL A-SENHA"
	CLR	RS		;SELECIONA DISPLAY PARA COMANDOS
	MOV	A,#0C0H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 1 / COLUNA 0)
	SETB	RS		;SELECIONA DISPLAY PARA DADOS
	MOV	A,#'3'
	ACALL	ESCREVE
	MOV	A,#'-'
	ACALL	ESCREVE
	MOV	A,#'S'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	MOV	A,#'I'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#'L'
	ACALL	ESCREVE
	MOV	A,#' '
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#'-'
	ACALL	ESCREVE
	MOV	A,#'S'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'N'
	ACALL	ESCREVE
	MOV	A,#'H'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	RET

;-------------------------- MENSAGEM MOTOR -----------------------------
;ESTA ROTINA ESCREVE NA TELA DO LCD, COM AS FRASES
; LINHA 1:  VELOCIDADE: X
; LINHA 2:         #-VOLTA
M_MOTOR:	CLR	RS		;SELECIONA DISPLAY P/ COMANDOS
		MOV	A,#1
		ACALL	ESCREVE		;ESCREVE COMANDO PARA LIMPAR A TELA
		MOV	A,#2
		ACALL	DELAY		;DELAY DE 1ms
		MOV	A,#0AH
		ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
		MOV	A,#2
		ACALL	DELAY		;DELAY DE 1ms
		MOV	A,#0CH
		ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
		MOV	A,#2
		ACALL	DELAY		;DELAY DE 1ms
		MOV	A,#80H
		ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 0 / COLUNA 0)
		SETB	RS		;SELECIONA O DISPLAY P/ DADO
; COMANDOS PARA ESCREVER AS LETRAS DE "VELOCIDADE: X"
	MOV	A,#'V'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'L'
	ACALL	ESCREVE
	MOV	A,#'O'
	ACALL	ESCREVE
	MOV	A,#'C'
	ACALL	ESCREVE
	MOV	A,#'I'
	ACALL	ESCREVE
	MOV	A,#'D'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#'D'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#':'
	ACALL	ESCREVE

; COMANDOS PARA ESCREVER AS LETRAS DE "#-VOLTA"
	CLR	RS		;SELECIONA DISPLAY PARA COMANDOS
	MOV	A,#0C1H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 1 / COLUNA 1)
	SETB	RS		;SELECIONA DISPLAY PARA DADOS
	MOV	A,#23H
	ACALL	ESCREVE
	MOV	A,#' '
	ACALL	ESCREVE
	MOV	A,#'V'
	ACALL	ESCREVE
	MOV	A,#'O'
	ACALL	ESCREVE
	MOV	A,#'L'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	RET

;-------------------------- MENSAGEM TEMPERATURA -----------------------------
;ESTA ROTINA ESCREVE NA TELA DO LCD, COM AS FRASES
; LINHA 1:  TEMPERATURA
; LINHA 2:  ATUAL: 
M_TEMP:	CLR	RS		;SELECIONA DISPLAY P/ COMANDOS
		MOV	A,#1
		ACALL	ESCREVE		;ESCREVE COMANDO PARA LIMPAR A TELA
		MOV	A,#2
		ACALL	DELAY		;DELAY DE 1ms
		MOV	A,#0AH
		ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
		MOV	A,#2
		ACALL	DELAY		;DELAY DE 1ms
		MOV	A,#0CH
		ACALL	ESCREVE		;ESCREVE COMANDO PARA DESLIGAR CURSOR
		MOV	A,#2
		ACALL	DELAY		;DELAY DE 1ms
		MOV	A,#82H
		ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 0 / COLUNA 2)
		SETB	RS		;SELECIONA O DISPLAY P/ DADO
; COMANDOS PARA ESCREVER AS LETRAS DE "TEMPERATURA"
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'M'
	ACALL	ESCREVE
	MOV	A,#'P'
	ACALL	ESCREVE
	MOV	A,#'E'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE
	MOV	A,#'T'
	ACALL	ESCREVE
	MOV	A,#'U'
	ACALL	ESCREVE
	MOV	A,#'R'
	ACALL	ESCREVE
	MOV	A,#'A'
	ACALL	ESCREVE

; COMANDOS PARA ESCREVER AS LETRAS DE "ATUAL: XXXºC"
	CLR	RS		;SELECIONA DISPLAY PARA COMANDOS
	MOV	A,#0C8H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 1 / COLUNA 6)
	SETB	RS		;SELECIONA DISPLAY PARA DADOS

	MOV	A,#0DFH
	ACALL	ESCREVE
	MOV	A,#'C'
	ACALL	ESCREVE
	RET

;======================================================================================
;================== CONFIGURAÇÕES INICIAIS DE HARDWARE E SOFTWARE =====================
;======================================================================================
; NESTA ROTINA SERÁ FEITO AS CONFIGURAÇÕES INICIAS DO PROGRAMA

CONFIG:	MOV	SP,#2FH		;DESLOCAMENTO DA PILHA
	MOV	IE,#8BH		;HABILITAÇÃO DAS INTERRUPÇÕES
				;HABILITA O TIMER0 O TIMER 1 A EXT_0 E A HABILITAÇÃO GERAL
	MOV	IP,#01H		;PRIORIDADES DAS INTERRUPÇÕES
				;PRIORIDADE MAIOR PARA EXT_0
	MOV	TMOD,#12H	;TIMR_0 EM MODO 2 R TIMER_1 EM MODO 1
	MOV	TH0,#00CH	;CHAMADA A CADA 256us
	MOV	TL0,#00CH	
	MOV	TH1,#9EH	;CHAMADA A CADA 25000us
	MOV	TL1,#58H
	SETB	IT0		;HABILITA O TIMER0 PARA BORDA DE DESCIDA
	SETB	IT1		;HABILITA O TIMAR1 PARA BORDA DE DESCIDA
	CLR	TR0		;DESLIGA O TIMER0
	CLR	TR1		;DESLIGA O TIMAR1
	CLR	FLAG		;INICIALIZA A FLAG ZERADA
	CLR	FLAG_SENHA	;GARANTE INICIALIZAÇÃO IGUAL A ZERO
	MOV	A,#00H
	MOV	P2,A		;INICIALIZA A PORTA 2 TODA EM BAIXO
	MOV	R6,#0EFH	;INICIALIZA R6 COM EFH PARA ROTACIONAR NO TIMER 0
	MOV	R0,#22H		;INICIALIZA R0 COM 22H PARA MEMÓRIA INICIAL DE SALVAMENTO
IN_1:	MOV	@R0,#'F'	;\
	INC	R0		;  >INSTRUÇÃO PARA GARANTIR O VALOR INICIAL DEFINIDO E DIFERENTE DA SENHA
	CJNE	R0,#27H,IN_1	;/
	MOV	R0,#22H
	MOV	A,#0FFH		
	MOV	TECLA,A		;INICIALIZA P1 TODA EM NIVEL LÓGICO ALTO
	

; TEMPO PARA ESTABILIZAÇÃO DE LIGAMENTO DO DISPLAY LCD
	MOV	A,#250
	ACALL	DELAY		;DELAY DE 100ms
	

; CONFIGURAÇÃO INICIAL DO DISPLAY
; INICIALIZA O DISPLAY P/ COMUNIÇÃO DE 4 VIAS, DISPLAY PARA 2 LINHAS,
; CURSOR APAGADO E DESLOCAMENTO DO CURSOR À DIREITA.

	CLR	RS		;SELECIONA O DISPLAY P/ COMANDOS

;	MOV	A,#30H		ESCREVE COMANDO 30H PARA INICIALIZAÇÃO
;	MOV	DISPLAY,A	ATUALIZA DISPLAY (P2)
	SETB	P2.4
	SETB	P2.5
	SETB	P2.6
	CLR	P2.7
	NOP			;TEMPO DE ESTABILIZAÇÃO
	SETB	ENABLE		;ENVIA UM PULSO DE ENABLE AO DISPLAY
	NOP
	NOP			;TEMPO DE ESTABILIZAÇÃO
	CLR	ENABLE		
	MOV	A,#8
	ACALL	DELAY		;DELAY DE 4ms (EXIGIDO PELO DISPLAY)

;	MOV	A,#30H		ESCREVE COMANDO 30H PARA INICIALIZAÇÃO
;	MOV	DISPLAY,A	ATUALIZA DISPLAY (P2)
	SETB	P2.4
	SETB	P2.5
	SETB	P2.6
	CLR	P2.7
	NOP			;TEMPO DE ESTABILIZAÇÃO
	SETB	ENABLE		;ENVIA UM PULSO DE ENABLE AO DISPLAY
	NOP
	NOP			;TEMPO DE ESTABILIZAÇÃO
	CLR	ENABLE		
	MOV	A,#4
	ACALL	DELAY		;DELAY DE 1ms (EXIGIDO PELO DISPLAY)

;	MOV	A,#30H		ESCREVE COMANDO 30H PARA INICIALIZAÇÃO
;	MOV	DISPLAY,A	ATUALIZA DISPLAY (P2)
	SETB	P2.4
	SETB	P2.5
	SETB	P2.6
	CLR	P2.7
	NOP			;TEMPO DE ESTABILIZAÇÃO
	SETB	ENABLE		;ENVIA UM PULSO DE ENABLE AO DISPLAY
	NOP
	NOP			;TEMPO DE ESTABILIZAÇÃO
	CLR	ENABLE		
	MOV	A,#4
	ACALL	DELAY		;DELAY DE 1ms (EXIGIDO PELO DISPLAY)

;	MOV	A,#00100000B	ESCREVE COMANDO PARA ESTABELECER COMUNICAÇÃO DE 4 VIAS
;	MOV	DISPLAY,A	ATUALIZA DISPLAY (P2)
	CLR	P2.4
	SETB	P2.5
	CLR	P2.6
	CLR	P2.7
	NOP
	SETB	ENABLE		;ENVIA UM PULSO DE ENABLE AO DISPLAY
	NOP
	NOP
	CLR	ENABLE
	MOV	A,#4
	ACALL	DELAY		;DELAY DE 1ms (EXIGIDO PELO DISPLAY)

	MOV	A,#28H		;ESCREVE COMANDO PARA DISPLAY DE DUAS LINHAS E MATRIZ 7x5
	ACALL	ESCREVE	
	MOV	A,#00000001B	;ESCREVE COMANDO PARA LIMPAR TODO O DISPLAY
	ACALL	ESCREVE
	MOV	A,#4
	ACALL	DELAY		;DELAY DE 1ms
	MOV	A,#00001100B	;LIGA DISPLAY SEM CURSOR
	ACALL	ESCREVE
	MOV	A,#00000110B	;DESLOCAMENTO AUTOMÁTICO À DIREITA DO CURSOR
	ACALL	ESCREVE
	SETB	RS		;SELECIONA DISPLAY PARA DADOS

; INICIO ROTINA PRINCIPAL DO PROGRAMA A SER EXECUTADO

INICIO:	ACALL	TELA_S		;CHAMADA DA TELA DE SENHA
	SETB	TR0		;HABILITA O TIMER 0
PART_0:	JB	FLAG,PART_1	;VERIFICA A FLAG PARA HABILITAR DE FORMA CORRETA O TIMER0
	AJMP	PART_0		;VOLTA PARA A VERIFICAÇÃO DA FLAG

PART_2:	CJNE	R0,#27H,PART_3		;COMPARA SE R0 JA FOI INCREMENTADO 5 VEZES
	CLR	EX0			;DESABILITA A EXTERNA 0
	ACALL	COMPARA			;CHAMA ROTINA DE COMPARAÇÃO DE SENHA
	CLR	FLAG			;GARANTE FLAG ZERO PARA A PRÓXIMA CHAMADA
	JB	FLAG_SENHA,PART_4	;VERIFICA SE SENHA ESTA CORRETA, SE ESTIVER VAI PARA MENU PART_4
	ACALL	M_ERRO			;CASO A SENHA NÃO ESTEJA CORRETO CHAMA MENSAGEM DE ERRO
	MOV	10H,#25			;TEMPO PARA VISUALIZACAO DA MENSAGEM
	MOV	A,#250
	ACALL	DELAY			;CHAMADA DE UMA ROTINA DE ~125ms
	DJNZ	10H,$-2
	MOV	R0,#22H
	SETB	EX0			;HABILITA A EXTERNA 0
	AJMP	INICIO			;VOLTA PARA O INICIO


PART_1:	MOV	A,@R0
	ACALL	ESCREVE
	INC	R0
	AJMP	PART_2
PART_3:	MOV	10H,#5		;TEMPO DE ESPERA PARA UM NOVO DÍGITO
	MOV	A,#255		;CHAMA ROTINA DE APROXIMADAMENTE DE 123ms
	ACALL	DELAY
	DJNZ	10H,$-2		;VOLTA PARA CARREGAR, PERDER MAIS 123ms SE 10H NAO FOR ZERO 
	SETB	TR0		;HABILITA O TIMER 0
	CLR	FLAG		;LIMPA A FLAG AUXILIAR DO TECLADO
	AJMP	PART_0		;VOLTA PARA A VERIFICAÇÃO DA FLAG


PART_4:	MOV	R0,#22H
	MOV	@R0,#00H	;GARANTE VALOR DESCONHECIDO PARA A PRÓXIMA COMPARAÇÃO
	ACALL	M_MENU		;MENSAGEM DE MENU
	MOV	10H,#5		;TEMPO DE ESPERA PARA UM NOVO DÍGITO
	MOV	A,#255		;CHAMA ROTINA DE APROXIMADAMENTE DE 123ms
	ACALL	DELAY
	DJNZ	10H,$-2		;VOLTA PARA CARREGAR, PERDER MAIS 123ms SE 10H NAO FOR ZERO 
	SETB	EX0		;HABILITA A EXTERNA 0
	CLR	FLAG
	SETB	TR0		;LIGA O TIMER 0

PART_8:	JNB	FLAG,$
	CJNE	@R0,#'1',PART_5
	MOV	0AH,#1		;INICIALIZA O RIGISTRADOR UTILIZADO NO TIMER 1
	MOV	@R0,#'0'	;PARA INICIALIZAR COM VELOCIDADE 0
	CLR	FLAG
	AJMP	MOTOR
PART_5:	CJNE	@R0,#'2',PART_6
	CLR	FLAG
	AJMP	TEMP
PART_6:	CJNE	@R0,#'3',PART_7
	CLR	FLAG
	AJMP	PART_9
PART_7:	CJNE	@R0,#'A',PART_9
	CLR	FLAG
	MOV	10H,#5		;TEMPO DE ESPERA PARA UM NOVO DÍGITO
	MOV	A,#255		;CHAMA ROTINA DE APROXIMADAMENTE DE 123ms
	ACALL	DELAY
	DJNZ	10H,$-2		;VOLTA PARA CARREGAR, PERDER MAIS 123ms SE 10H NAO FOR ZERO 
	CLR	FLAG_SENHA
	AJMP	INICIO

PART_9: 	CLR	FLAG
		SETB	TR0		;LIGA O TIMER 0
		AJMP	PART_8
;----------------------------- MOTOR DE PASSO -----------------------------------
MOTOR:	ACALL	M_MOTOR
	MOV	10H,#5		;TEMPO DE ESPERA PARA UM NOVO DÍGITO
	MOV	A,#255		;CHAMA ROTINA DE APROXIMADAMENTE DE 123ms
	ACALL	DELAY
	DJNZ	10H,$-2		;VOLTA PARA CARREGAR, PERDER MAIS 123ms SE 10H NAO FOR ZERO
	MOV	@R0,#'0'	;PARA INICIALIZAR COM VELOCIDADE 0
	MOV	R3,#01H
	SETB	TR0
	SETB	TR1		;LIGA O TIMER 1
MT_3:	CJNE	@R0,#'0',MT_1
	CLR	TR1
	AJMP	MT_4
MT_1:	CJNE	@R0,#23H,MT_2
	CLR	TR1		;DESLIGA O TIMER 1 ANTES DE SAIR DA ROTINA DO MOTOR
	AJMP	PART_4		;VOLTA PARA O MENU

MT_2:	SETB	TR1
MT_4:	JNB	FLAG_MOTOR,MT_3
	CLR	FLAG_MOTOR
	CLR	RS		;SELECIONA DISPLAY PARA COMANDOS
	MOV	A,#08DH
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 1 / COLUNA 1)
	SETB	RS		;SELECIONA DISPLAY PARA DADOS
	MOV	A,@R0
	ACALL	ESCREVE
	SETB	TR0
	AJMP	MT_3
	
;---------------------------------- TEMPERATURA ---------------------------------------
TEMP:	ACALL	M_TEMP
	MOV	10H,#5		;TEMPO DE ESPERA PARA UM NOVO DÍGITO
	MOV	A,#255		;CHAMA ROTINA DE APROXIMADAMENTE DE 123ms
	ACALL	DELAY
	DJNZ	10H,$-2		;VOLTA PARA CARREGAR, PERDER MAIS 123ms SE 10H NAO FOR ZERO
	MOV	@R0,#00H	;GARANTE VALOR DIFERENTE DE 23H

TE_1:	SETB	TR0
	MOV	0F0H,#100
	MOV	A,P0
	DIV	AB
	MOV	0CH,A
	MOV	A,0F0H
	MOV	0F0H,#10
	DIV	AB
	MOV	0DH,A
	
	CLR	RS		;SELECIONA DISPLAY PARA COMANDOS
	MOV	A,#0C5H
	ACALL	ESCREVE		;COMANDO PARA POSICIONAR O CURSOR (LINHA 1 / COLUNA 10)
	SETB	RS		;SELECIONA DISPLAY PARA DADOS
	MOV	A,0CH
	ADD	A,#30H
	ACALL	ESCREVE

	MOV	A,0DH
	ADD	A,#30H
	ACALL	ESCREVE

	MOV	A,0F0H
	ADD	A,#30H
	ACALL	ESCREVE

	MOV	10H,#5		;TEMPO DE ESPERA PARA UM NOVO DÍGITO
TE_0:	CJNE	@R0,#23H,TE_2
	CLR	TR0		;DESLIGA TIMER 0 PARA SAIR DA ROTINA
	AJMP	PART_4		;VOLTA PARA O MENU SE # FOR PRESSIONADO

TE_2:	MOV	A,#255		;CHAMA ROTINA DE APROXIMADAMENTE DE 123ms
	ACALL	DELAY
	DJNZ	10H,TE_0	;VOLTA PARA ANALIZAR A TECLA PRESSIONADA E PERDER MAIS 123ms SE 10H NAO FOR ZERO
	AJMP	TE_1

;---------------------------- FIM DO PROGRAMA -----------------------------------
	END